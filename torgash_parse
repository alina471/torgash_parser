import re
import json
from bs4 import BeautifulSoup

def extract_numeric_value(text_string):
    numbers_only = re.sub(r"[^\d]", "", text_string)
    return int(numbers_only) if numbers_only else 0

def process_auction_data(file_path="torgi_page.html"):
    with open(file_path, "r", encoding="utf-8") as file:
        html_content = file.read()
    
    parser = BeautifulSoup(html_content, "html.parser")
    auction_items = []

    # Анализируем табличные строки
    for table_row in parser.find_all("tr"):
        columns = table_row.find_all("td")
        
        # Пропускаем строки с недостаточным количеством данных
        if len(columns) < 6:
            continue

        # Извлекаем информацию о лоте
        link_element = columns[1].find("a", href=True)
        if not link_element:
            continue

        item_name = link_element.get_text(strip=True)
        item_url = link_element["href"]
        
        # Обрабатываем цену
        price_string = columns[5].get_text(strip=True)
        item_price = extract_numeric_value(price_string)

        auction_items.append({
            "name": item_name,
            "cost": item_price,
            "url": item_url
        })

    return auction_items

def execute_parser():

    print("=== АНАЛИЗ АУКЦИОНОВ TORGI.ORG ===")
    
    items = process_auction_data()
    
    if not items:
        print("Аукционные лоты не обнаружены.")
        return

    # Получаем параметры фильтрации
    print("\nВведите диапазон цен (оставьте пустым для отключения фильтра):")
    min_input = input("Нижняя граница цены: ").strip()
    max_input = input("Верхняя граница цены: ").strip()

    # Обрабатываем границы цен
    min_value = extract_numeric_value(min_input) if min_input else 0
    max_value = extract_numeric_value(max_input) if max_input else float('inf')

    # Применяем фильтрацию
    filtered_items = [item for item in items if min_value <= item["cost"] <= max_value]
    
    # Сортируем по стоимости (убывание)
    filtered_items.sort(key=lambda x: x["cost"], reverse=True)

    # Выводим результаты
    print(f"\nНайдено подходящих лотов: {len(filtered_items)}\n")
    
    for item in filtered_items:
        price_display = f"{item['cost']} ₽" if item['cost'] > 0 else "бесплатно"
        print(f" {item['name']}")
        print(f"   Стоимость: {price_display}")
        print(f"   Адрес: {item['url']}\n")

    # Сохраняем в файл
    output_data = {
        "total_count": len(filtered_items),
        "auction_items": filtered_items
    }
    
    with open("auction_results.json", "w", encoding="utf-8") as output_file:
        json.dump(output_data, output_file, ensure_ascii=False, indent=2)

    print(f"Результаты сохранены в файл: auction_results.json")

if __name__ == "__main__":
    execute_parser()
